(()=>{var e={181:(e,t,o)=>{var i=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,n=/^0b[01]+$/i,s=/^0o[0-7]+$/i,a=parseInt,c="object"==typeof o.g&&o.g&&o.g.Object===Object&&o.g,l="object"==typeof self&&self&&self.Object===Object&&self,d=c||l||Function("return this")(),u=Object.prototype.toString,p=Math.max,g=Math.min,f=function(){return d.Date.now()};function v(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function m(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==u.call(e)}(e))return NaN;if(v(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=v(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(i,"");var o=n.test(e);return o||s.test(e)?a(e.slice(2),o?2:8):r.test(e)?NaN:+e}e.exports=function(e,t,o){var i,r,n,s,a,c,l=0,d=!1,u=!1,h=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function y(t){var o=i,n=r;return i=r=void 0,l=t,s=e.apply(n,o)}function b(e){var o=e-c;return void 0===c||o>=t||o<0||u&&e-l>=n}function S(){var e=f();if(b(e))return R(e);a=setTimeout(S,function(e){var o=t-(e-c);return u?g(o,n-(e-l)):o}(e))}function R(e){return a=void 0,h&&i?y(e):(i=r=void 0,s)}function _(){var e=f(),o=b(e);if(i=arguments,r=this,c=e,o){if(void 0===a)return function(e){return l=e,a=setTimeout(S,t),d?y(e):s}(c);if(u)return a=setTimeout(S,t),y(c)}return void 0===a&&(a=setTimeout(S,t)),s}return t=m(t)||0,v(o)&&(d=!!o.leading,n=(u="maxWait"in o)?p(m(o.maxWait)||0,t):n,h="trailing"in o?!!o.trailing:h),_.cancel=function(){void 0!==a&&clearTimeout(a),l=0,i=c=r=a=void 0},_.flush=function(){return void 0===a?s:R(f())},_}},206:e=>{"use strict";e.exports=ReactDOM},304:function(e,t,o){"use strict";var i,r=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,r)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[t.length]=o);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o=i(e),s=0;s<o.length;s++)"default"!==o[s]&&r(t,e,o[s]);return n(t,e),t}),a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const c=s(o(594)),l=o(508),d=a(o(982));t.default=({post:e})=>{var t;if(console.log("🔄 [PostReceipt] Rendering:",{postId:null==e?void 0:e.id,hasPost:!!e,timestamp:(new Date).toISOString()}),!(null==e?void 0:e.id))return console.warn("⚠️ [PostReceipt] Invalid post:",e),null;const o=e.id,[i,r]=(0,c.useState)([]),n=(null===(t=document.cookie.match(/MMUSERID=([^;]+)/))||void 0===t?void 0:t[1])||window.localStorage.getItem("MMUSERID")||"",s=e.user_id===n;(0,c.useEffect)((()=>{const e=(0,l.getMessageReadReceipts)(o);console.log("📥 [PostReceipt] Loading receipts:",{messageId:o,receipts:e,isOwnMessage:s,currentUserId:n,timestamp:(new Date).toISOString()}),r(e);const t=e=>{const t=e,{type:i,receipts:n}=t.detail;if(console.log("🔄 [PostReceipt] Store update event:",{type:i,messageId:o,hasReceipts:!!n,timestamp:(new Date).toISOString()}),"receipts_loaded"===i&&n){const e=n.find((e=>e.messageId===o));if(e)return console.log("✨ [PostReceipt] Using receipt from event:",{messageId:o,users:e.users}),void r(e.users)}r((0,l.getMessageReadReceipts)(o))};return window.addEventListener(l.RECEIPT_STORE_UPDATE,t),()=>{window.removeEventListener(l.RECEIPT_STORE_UPDATE,t)}}),[o]),(0,c.useEffect)((()=>{const e=e=>{const t=e;if("custom_mattermost-readreceipts_read_receipt"===t.detail.event){const{message_id:e,user_id:i}=t.detail.data;e===o&&(console.log("👁️ [PostReceipt] Receipt event:",{messageId:e,userId:i,username:(0,l.getUserDisplayName)(i),timestamp:(new Date).toISOString()}),r((e=>e.includes(i)?e:[...e,i])))}};return console.log("👂 [PostReceipt] Adding WebSocket listener:",{messageId:o,timestamp:(new Date).toISOString()}),window.addEventListener("mattermost-websocket-event",e),()=>{console.log("🗑️ [PostReceipt] Removing WebSocket listener:",{messageId:o,timestamp:(new Date).toISOString()}),window.removeEventListener("mattermost-websocket-event",e)}}),[o]);const a=i.filter((t=>t!==n&&t!==e.user_id)),u=a.map((e=>(0,l.getUserDisplayName)(e)));return console.log("👀 [PostReceipt] Preparing display:",{messageId:o,seenByOthers:a,seenByOthersDisplay:u,isOwnMessage:s,authorId:e.user_id,currentUserId:n,timestamp:(new Date).toISOString()}),c.default.createElement("div",{className:"post-receipt-container","data-post-id":o,"data-component":"post-receipt","data-is-own-message":s,"data-author-id":e.user_id},!s&&c.default.createElement(d.default,{messageId:o,postAuthorId:e.user_id,key:`tracker-${o}`}),a.length>0&&c.default.createElement("div",{className:"post-receipt",style:{fontSize:"11px",color:"rgba(63, 67, 80, 0.72)",padding:"4px 0",marginTop:"2px",display:"inline-flex",alignItems:"center"},"data-seen-by":a.join(",")},c.default.createElement("span",{className:"read-receipt-text"},"Seen by ",u.join(", "))))}},314:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleWebSocketEvent=function(e){return e=>{console.log("📡 [WebSocket] Raw event received:",{event:e.type,data:e.data,origin:e.origin});try{const t=JSON.parse(e.data);if(console.log("🔍 [WebSocket] Parsed event:",{type:t.event,data:t.data}),"multiple_channels_viewed"===t.event){const{channel_ids:e}=t.data;e&&Array.isArray(e)&&(console.log("👀 [WebSocket] Multiple channels viewed:",e),Promise.all(e.map((e=>(0,i.loadInitialReceipts)(e)))).catch((e=>{console.error("❌ [WebSocket] Failed to load receipts:",e)})))}else if(t.event&&t.event.endsWith("_read_receipt")){const{message_id:e,user_id:o}=t.data;console.log("📬 [WebSocket] Processing read receipt:",{messageId:e,userId:o,username:(0,i.getUserDisplayName)(o)}),(0,i.updateReadReceipts)(e,o);const r=new CustomEvent("mattermost-websocket-event",{detail:{event:"custom_mattermost-readreceipts_read_receipt",data:{message_id:e,user_id:o}}});console.log("🔔 [WebSocket] Dispatching event to components:",{event:r.type,detail:r.detail}),window.dispatchEvent(r)}else console.log("⏭️ [WebSocket] Ignoring non-receipt event:",t.event)}catch(t){console.error("❌ [WebSocket] Error handling event:",{error:t.message,stack:t.stack,event:e})}}},t.initializeWebSocket=function(){console.log("🌐 [WebSocket] Initializing connection...");const e=new WebSocket("/api/v4/websocket");return e.onopen=()=>{console.log("✅ [WebSocket] Connection established")},e.onerror=t=>{console.error("❌ [WebSocket] Connection error:",{error:t,readyState:e.readyState})},e.onclose=()=>{console.warn("⚠️ [WebSocket] Connection closed",{wasClean:3===e.readyState,readyState:e.readyState})},e};const i=o(508)},508:function(e,t){"use strict";var o=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(r,n){function s(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))};let i;Object.defineProperty(t,"__esModule",{value:!0}),t.visibilityThresholdMs=t.RECEIPT_STORE_UPDATE=t.loadInitialReceipts=t.getUserDisplayName=t.getUserProfiles=t.updateReadReceipts=t.getMessageReadReceipts=t.getReadReceipts=t.setMattermostStore=void 0,t.fetchPluginConfig=function(){return o(this,void 0,void 0,(function*(){try{const e=yield fetch("/plugins/mattermost-readreceipts/api/v1/config");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const o=yield e.json();"number"==typeof o.visibility_threshold_ms&&(t.visibilityThresholdMs=o.visibility_threshold_ms,t.visibilityThresholdMs||(t.visibilityThresholdMs=2e3,console.log("⚙️ [Store] Invalid threshold received, using default:",t.visibilityThresholdMs)),console.log("⚙️ [Store] Updated visibility threshold:",t.visibilityThresholdMs))}catch(e){console.error("❌ [Store] Failed to fetch plugin config:",e)}}))};const r=new Map;t.setMattermostStore=e=>{i=e,console.log("🔌 [Store] Initialized with Mattermost store:",{hasStore:!!e,userProfiles:Object.keys(e.getState().entities.users.profiles).length})},t.getReadReceipts=()=>{const e={};return r.forEach(((t,o)=>{e[o]=Array.from(t)})),console.log("📖 [Store] Getting all read receipts:",{messageCount:r.size,messages:Array.from(r.keys()),state:e}),e},t.getMessageReadReceipts=e=>{const t=r.get(e),o=t?Array.from(t):[];return console.log("👀 [Store] Getting receipts for message:",{messageId:e,receipts:o,allMessages:Array.from(r.keys())}),o},t.updateReadReceipts=(e,t)=>{console.log("✏️ [Store] Updating receipts:",{messageId:e,userId:t,beforeState:r.get(e)}),r.has(e)||r.set(e,new Set);const o=r.get(e),i=!o.has(t);o.add(t),i?console.log("✅ [Store] Receipt added:",{messageId:e,userId:t,afterState:Array.from(o)}):console.log("ℹ️ [Store] Receipt already exists:",{messageId:e,userId:t})},t.getUserProfiles=()=>{const e=i.getState().entities.users.profiles;return console.log("👥 [Store] Getting user profiles:",{count:Object.keys(e).length,users:Object.keys(e).map((t=>({id:t,username:e[t].username})))}),e},t.getUserDisplayName=e=>{const o=(0,t.getUserProfiles)()[e];if(!o)return console.warn("⚠️ [Store] User profile not found:",e),e;const i=o.nickname||`${o.first_name||""} ${o.last_name||""}`.trim()||o.username;return console.log("👤 [Store] Getting display name:",{userId:e,displayName:i,user:o}),i};const n="mattermost-readreceipts_store_update";t.loadInitialReceipts=e=>o(void 0,void 0,void 0,(function*(){console.log("🔄 [Store] Loading receipts for channel:",e);try{const t=yield fetch(`/plugins/mattermost-readreceipts/api/v1/receipts?channel_id=${encodeURIComponent(e)}`,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"include"});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=yield t.json();console.log("📥 [Store] Received receipts:",{channelId:e,count:o.length,receipts:o});const i=new Map;for(const e of o){const t=i.get(e.message_id)||new Set;t.add(e.user_id),i.set(e.message_id,t)}i.forEach(((e,t)=>{r.set(t,e)})),console.log("💾 [Store] Updated receipt map:",{channelId:e,messageCount:i.size,messages:Array.from(i.keys())});const s=new CustomEvent(n,{detail:{type:"receipts_loaded",channelId:e,messageCount:i.size,receipts:Array.from(i.entries()).map((([e,t])=>({messageId:e,users:Array.from(t)})))}});window.dispatchEvent(s),console.log("📢 [Store] Dispatched store update event:",{type:"receipts_loaded",channelId:e,messageCount:i.size})}catch(t){throw console.error("❌ [Store] Failed to load receipts:",{channelId:e,error:t}),t}})),t.RECEIPT_STORE_UPDATE=n,t.visibilityThresholdMs=2e3},594:e=>{"use strict";e.exports=React},720:function(e,t,o){"use strict";var i,r=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,r)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[t.length]=o);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o=i(e),s=0;s<o.length;s++)"default"!==o[s]&&r(t,e,o[s]);return n(t,e),t}),a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const c=s(o(594)),l=a(o(206)),d=a(o(304));t.default=()=>((0,c.useEffect)((()=>{let e=null,t=null,o=0;function i(e){const t=e.id||e.getAttribute("id")||"",o=t.replace(/^post_/,"");if(!o)return void console.warn("⚠️ [RootObserver] Post node without ID:",e);if(console.log("📨 [RootObserver] Processing post:",{postId:o,nodeId:t,hasReceiptContainer:null!==e.querySelector(".post-receipt-container")}),e.querySelector(".post-receipt-container"))return void console.log("ℹ️ [RootObserver] Receipt already attached:",o);let i=e.querySelector(".post-receipt-mount-point");if(!i){console.log("🏗️ [RootObserver] Creating receipt container for:",o),i=document.createElement("div"),i.className="post-receipt-mount-point";const t=e.querySelector(".post-message__text")||e.querySelector(".post__body");if(!t||!t.parentNode)return void console.warn("⚠️ [RootObserver] Could not find message container:",o);t.parentNode.insertBefore(i,t.nextSibling)}const r=(e=>{var t,o,i,r,n;const s=null===(o=null===(t=window.store)||void 0===t?void 0:t.getState)||void 0===o?void 0:o.call(t),a=null===(n=null===(r=null===(i=null==s?void 0:s.entities)||void 0===i?void 0:i.posts)||void 0===r?void 0:r.posts)||void 0===n?void 0:n[e];return console.log("🔍 [RootObserver] Getting author from store:",{postId:e,authorId:null==a?void 0:a.user_id,hasPost:!!a}),(null==a?void 0:a.user_id)||""})(o);console.log("🎨 [RootObserver] Rendering PostReceipt for:",{postId:o,authorId:r,source:"redux_store"}),l.default.render(c.default.createElement(d.default,{post:{id:o,user_id:r}}),i)}function r(){const r=[".post-list__content",".post-list__body",".post-list",'[role="main"]'];let n=null;for(const e of r)if(n=document.querySelector(e),n)break;n?(e=new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e instanceof HTMLElement&&(e.matches('[data-testid="postView"]')&&i(e),e.querySelectorAll('[data-testid="postView"]').forEach((e=>{i(e)})))}))}))})),e.observe(n,{childList:!0,subtree:!0}),console.log("👀 [RootObserver] Attached to:",n),n.querySelectorAll('[data-testid="postView"]').forEach((e=>{i(e)})),t&&window.clearInterval(t)):(o+=1,o>100&&(t&&window.clearInterval(t),console.warn("⚠️ [RootObserver] No container found after 10s")))}return t=window.setInterval(r,100),r(),()=>{t&&window.clearInterval(t),e&&e.disconnect()}}),[]),null)},982:function(e,t,o){"use strict";var i,r=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,r)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[t.length]=o);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o=i(e),s=0;s<o.length;s++)"default"!==o[s]&&r(t,e,o[s]);return n(t,e),t}),a=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(r,n){function s(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))},c=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const l=s(o(594)),d=c(o(181)),u=o(508);t.default=({messageId:e,postAuthorId:t})=>{const o=(0,l.useRef)(null),i=(0,l.useRef)(null),[r,n]=(0,l.useState)(!1),s=(0,l.useRef)(null),c=(0,l.useRef)(null),p=()=>{let e=window.localStorage.getItem("MMUSERID");if(!e){const t=document.cookie.match(/MMUSERID=([^;]+)/);t&&(e=t[1],window.localStorage.setItem("MMUSERID",e))}return e?console.log("✅ [VisibilityTracker] Found userId:",e):console.error("❌ [VisibilityTracker] Missing MMUSERID in both localStorage and cookies"),e||""},g=()=>p()!==t,f=()=>{c.current&&(clearInterval(c.current),c.current=null),s.current&&(s.current=null),console.log(`⏱️ [VisibilityTracker] Reset visibility timer for ${e}`)},v=()=>{"visible"!==document.visibilityState?(console.log(`👁️ [VisibilityTracker] Tab hidden, resetting timer for ${e}`),f()):console.log("👁️ [VisibilityTracker] Tab visible, will restart timer if message is visible")},m=()=>{if(g()){if("visible"!==document.visibilityState)return console.log(`👁️ [VisibilityTracker] Tab not active, resetting timer for ${e}`),void f();if(s.current&&!r){const o=Date.now()-s.current;o>=u.visibilityThresholdMs&&(console.log(`⌛ [VisibilityTracker] Visibility threshold reached for ${e}:`,{duration:o,threshold:u.visibilityThresholdMs}),a(void 0,void 0,void 0,(function*(){var o,i;if(r)return void console.log(`ℹ️ [VisibilityTracker] Already sent receipt for: ${e}`);if(!g())return void console.log("ℹ️ [VisibilityTracker] Skipping read receipt for author's own message:",{messageId:e,postAuthorId:t,currentUserId:p()});const a=p(),c=(null===(o=document.cookie.match(/MMCSRF=([^;]+)/))||void 0===o?void 0:o[1])||"";if(a){console.log("📤 [VisibilityTracker] Preparing to send read receipt:",{messageId:e,userId:a,hasCSRF:!!c,cookieUserId:null===(i=document.cookie.match(/MMUSERID=([^;]+)/))||void 0===i?void 0:i[1],localStorageUserId:window.localStorage.getItem("MMUSERID"),visibilityDuration:s.current?Date.now()-s.current:0});try{const t=yield fetch("/plugins/mattermost-readreceipts/api/v1/read",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":c,"Mattermost-User-Id":a},credentials:"same-origin",body:JSON.stringify({message_id:e,debug:{timestamp:(new Date).toISOString(),source:"visibility_tracker",visibilityDuration:s.current?Date.now()-s.current:0}})});if(console.log("📨 [VisibilityTracker] Server response:",{status:t.status,ok:t.ok,text:yield t.text(),requestHeaders:{"Content-Type":"application/json","X-CSRF-Token":c?"(present)":"(missing)","Mattermost-User-Id":a}}),!t.ok)throw new Error(`Server returned ${t.status}`);console.log(`✅ [VisibilityTracker] Read receipt sent successfully for ${e}`),n(!0)}catch(t){console.error("❌ [VisibilityTracker] Failed to send receipt:",{messageId:e,error:t instanceof Error?t.message:String(t),requestUrl:"/plugins/mattermost-readreceipts/api/v1/read",userId:a,csrfToken:c?"(present)":"(missing)",cookieInfo:document.cookie?{hasMmUserId:!!document.cookie.match(/MMUSERID=/),hasCsrf:!!document.cookie.match(/MMCSRF=/),allCookies:document.cookie.split(";").map((e=>e.trim().split("=")[0]))}:"(no cookies)"})}}else console.error("❌ [VisibilityTracker] Missing MMUSERID")})),f())}}else f()},h=(0,d.default)((t=>{const o=t[0],i=o.isIntersecting&&o.intersectionRatio>=.5,n="visible"===document.visibilityState;console.log("👁️ [VisibilityTracker] Visibility changed:",{messageId:e,isIntersecting:o.isIntersecting,ratio:o.intersectionRatio,isVisible:i,isTabActive:n,hasSent:r,visibilityStartTime:s.current,userId:p()}),i&&n&&!s.current&&!r?(console.log(`⏳ [VisibilityTracker] Starting visibility timer for ${e}`),s.current=Date.now(),c.current&&clearInterval(c.current),c.current=setInterval(m,100)):i&&n||(console.log(`⏱️ [VisibilityTracker] Resetting visibility timer for ${e} (visible: ${i}, tab active: ${n})`),f())}),100);return(0,l.useEffect)((()=>{if(g())return console.log(`🔄 [VisibilityTracker] Setting up observer for ${e}`,{hasExistingObserver:!!o.current,hasElement:!!i.current}),i.current&&!o.current&&(o.current=new IntersectionObserver(h,{threshold:[.5],rootMargin:"0px"}),o.current.observe(i.current),console.log(`👀 [VisibilityTracker] Observer attached to element for ${e}`)),document.addEventListener("visibilitychange",v),()=>{console.log(`🧹 [VisibilityTracker] Cleaning up observers for ${e}`),f(),o.current&&o.current.disconnect(),document.removeEventListener("visibilitychange",v)};console.log("ℹ️ [VisibilityTracker] Skipping observer setup for author's message:",{messageId:e,postAuthorId:t,currentUserId:p()})}),[e]),l.default.createElement("div",{ref:i,style:{width:"100%",height:"10px",opacity:0},"data-testid":"visibility-tracker","data-message-id":e,"data-component":"visibility-tracker"})}},986:function(e,t,o){"use strict";var i=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(r,n){function s(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=r(o(594)),s=r(o(304)),a=o(314),c=o(508),l=r(o(720));class d{initialize(e,t){return i(this,void 0,void 0,(function*(){var o,r;console.log("🔌 [ReadReceiptPlugin] Initializing..."),(0,c.setMattermostStore)(t);try{yield(0,c.fetchPluginConfig)()}catch(e){console.error("❌ [ReadReceiptPlugin] Failed to fetch plugin config:",e)}console.log("🔌 [ReadReceiptPlugin] Initializing WebSocket..."),(0,a.initializeWebSocket)().onmessage=(0,a.handleWebSocketEvent)(t.dispatch),e.registerWebSocketEventHandler("multiple_channels_viewed",(e=>i(this,void 0,void 0,(function*(){var t;const o=null===(t=e.data)||void 0===t?void 0:t.channel_ids;o&&Array.isArray(o)&&(console.log("👀 [ReadReceiptPlugin] Channels viewed:",o),o.forEach((e=>{(0,c.loadInitialReceipts)(e).catch((t=>{console.error("❌ [ReadReceiptPlugin] Failed to load receipts:",{channelId:e,error:t})}))})))}))));try{const e=t.getState(),i=null===(r=null===(o=null==e?void 0:e.entities)||void 0===o?void 0:o.channels)||void 0===r?void 0:r.currentChannelId;i?(console.log("📥 [ReadReceiptPlugin] Pre-loading receipts for channel:",i),yield(0,c.loadInitialReceipts)(i).catch((e=>{console.error("❌ [ReadReceiptPlugin] Failed to pre-load receipts:",e)})),console.log("✅ [ReadReceiptPlugin] Pre-loaded receipts successfully")):console.log("ℹ️ [ReadReceiptPlugin] No active channel, skipping pre-load")}catch(e){console.error("❌ [ReadReceiptPlugin] Failed to pre-load receipts:",e)}e.registerRootComponent(l.default);try{e.registerPostTypeComponent&&(console.log("🧩 [ReadReceiptPlugin] Registering post component..."),e.registerPostTypeComponent((e=>{var t;return(null===(t=e.post)||void 0===t?void 0:t.id)&&""===e.post.type?(console.log("[ReadReceiptPlugin] Rendering for post:",e.post.id),n.default.createElement(s.default,{post:e.post})):null})),console.log("✅ [ReadReceiptPlugin] Post component registered"))}catch(e){console.error("❌ [ReadReceiptPlugin] Error in registerPostTypeComponent:",e)}try{console.log("🔌 [ReadReceiptPlugin] Registering WebSocket handler..."),e.registerWebSocketEventHandler("custom_mattermost-readreceipts_read_receipt",(0,a.handleWebSocketEvent)(t.dispatch)),console.log("✅ [ReadReceiptPlugin] WebSocket handler registered")}catch(e){console.error("❌ [ReadReceiptPlugin] Failed to register WebSocket handler:",e)}console.log("✅ [ReadReceiptPlugin] Initialization complete")}))}}t.default=d,window.registerPlugin&&window.registerPlugin("mattermost-readreceipts",new d)}},t={};function o(i){var r=t[i];if(void 0!==r)return r.exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,o),n.exports}o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o(986)})();
//# sourceMappingURL=main.js.map